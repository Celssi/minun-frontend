<form [formGroup]="editFormGroup" [ngClass.md]="{'pt-4': authService.isAuthenticated()}" [ngClass.xs]="{'pt-2': authService.isAuthenticated()}">
  <mat-toolbar *ngIf="authService.isAuthenticated()">
    <h2 class="text-white">{{'pageBuilder.title' | translate}}</h2>
    <div class="action-buttons">
      <button mat-raised-button color="primary" class="me-2" (click)="openBusinessCard()">
        <span>{{'pageBuilder.openBusinessCard' | translate}}</span>
        <mat-icon>open_in_new</mat-icon>
      </button>
      <button mat-raised-button color="primary" (click)="save()">
        <span>{{'miscellaneous.save' | translate}}</span>
        <mat-icon>save</mat-icon>
      </button>
    </div>
  </mat-toolbar>

  <div class="my-4">
    <app-image-selector [defaultImage]="user?.image" (imageChangedEmitter)="updateImage($event)" #imageSelector></app-image-selector>
  </div>

  <mat-card class="my-2">
    <h2>{{'pageBuilder.basicInfo' | translate}}</h2>
    <mat-form-field appearance="fill" class="width-all-available">
      <mat-label>{{'pageBuilder.accountType' | translate}}</mat-label>
      <mat-select formControlName="accountType" (selectionChange)="accountTypeChanged()" autofocus>
        <mat-option value="user">{{'pageBuilder.user' | translate}}</mat-option>
        <mat-option value="company">{{'pageBuilder.company' | translate}}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="fill" class="width-half-available" *ngIf="isUserForm()">
      <mat-label>{{'pageBuilder.firstName' | translate}}</mat-label>
      <input matInput type="text" formControlName="firstName" autocomplete="given-name" maxlength="100">
      <mat-error *ngIf="editForm.firstName.errors?.required">Tieto on pakollinen</mat-error>
    </mat-form-field>

    <mat-form-field appearance="fill" class="width-half-available" *ngIf="isUserForm()">
      <mat-label>{{'pageBuilder.lastName' | translate}}</mat-label>
      <input matInput type="text" formControlName="lastName" autocomplete="family-name" maxlength="100">
      <mat-error *ngIf="editForm.lastName.errors?.required">Tieto on pakollinen</mat-error>
    </mat-form-field>

    <mat-form-field appearance="fill" class="width-half-available" *ngIf="isUserForm() && user">
      <mat-label>{{'pageBuilder.workTitle' | translate}}</mat-label>
      <input matInput type="text" formControlName="title" autocomplete="off" maxlength="300">
    </mat-form-field>

    <mat-form-field appearance="fill" class="width-all-available" *ngIf="isCompanyForm()">
      <mat-label>{{'pageBuilder.companyName' | translate}}</mat-label>
      <input matInput type="text" formControlName="companyName" autocomplete="organization" maxlength="100">
    </mat-form-field>

    <mat-form-field appearance="fill" class="width-half-available" *ngIf="user">
      <mat-label>{{'pageBuilder.phone' | translate}}</mat-label>
      <input matInput type="text" formControlName="phone" autocomplete="tel" maxlength="300">
      <mat-error *ngIf="editForm.phone.errors?.wrongNumber">{{'pageBuilder.phoneWrongFormat' | translate}}</mat-error>
    </mat-form-field>

    <mat-form-field appearance="fill" [ngClass]="{'width-half-available': user, 'width-all-available': !user}">
      <mat-label>{{'pageBuilder.email' | translate}}</mat-label>
      <input matInput type="text" formControlName="email" autocomplete="email" (focusout)="validateEmail()" email maxlength="300">
      <mat-icon matSuffix matTooltip="Sähköpostia käytetään kirjautumiseen.">info</mat-icon>
      <mat-error *ngIf="editForm.email.errors?.emailNotValid">{{'pageBuilder.emailWrongFormat' | translate}}</mat-error>
      <mat-error *ngIf="editForm.email.errors?.alreadyExists">{{'pageBuilder.emailAlreadyUsed' | translate}}</mat-error>
      <mat-error *ngIf="editForm.email.errors?.required">{{'pageBuilder.requiredField' | translate}}</mat-error>
    </mat-form-field>

    <mat-form-field appearance="fill" class="width-half-available" *ngIf="user">
      <mat-label>{{'pageBuilder.webpage' | translate}}</mat-label>
      <input matInput type="text" formControlName="website" autocomplete="url" maxlength="300">
    </mat-form-field>

    <mat-form-field appearance="fill" class="width-half-available" *ngIf="user">
      <mat-label>{{'pageBuilder.location' | translate}}</mat-label>
      <input matInput type="text" formControlName="location" autocomplete="address-level2" maxlength="300">
    </mat-form-field>

    <mat-form-field appearance="fill" class="width-half-available" *ngIf="user">
      <mat-label>{{'pageBuilder.handle' | translate}}</mat-label>
      <input matInput type="text" formControlName="handle" autocomplete="off" maxlength="300" (focusout)="validateHandle()">
      <mat-icon matSuffix matTooltip="Kahvasi näkyy käyntikorttisi jakolinkissä.">info</mat-icon>
      <mat-error *ngIf="editForm.handle.errors?.required">{{'pageBuilder.requiredField' | translate}}</mat-error>
      <mat-error *ngIf="editForm.handle.errors?.alreadyExists">{{'pageBuilder.handleAlreadyUsed' | translate}}</mat-error>
    </mat-form-field>

    <mat-form-field appearance="fill" class="width-half-available" *ngIf="!user">
      <mat-label>{{'pageBuilder.password' | translate}}</mat-label>
      <input matInput type="password" formControlName="password" autocomplete="new-password" maxlength="300">
      <mat-icon matSuffix [matTooltip]="'pageBuilder.passwordDescription' | translate">info</mat-icon>
      <mat-error *ngIf="editForm.password.errors?.pattern">{{'pageBuilder.passwordWrongFormat' | translate}}</mat-error>
      <mat-error *ngIf="editForm.password.errors?.required">{{'pageBuilder.requiredField' | translate}}</mat-error>
    </mat-form-field>

    <mat-form-field appearance="fill" class="width-half-available" *ngIf="!user">
      <mat-label>{{'pageBuilder.passwordAgain' | translate}}</mat-label>
      <input matInput type="password" formControlName="passwordAgain" autocomplete="new-password" maxlength="300">
      <mat-error *ngIf="editForm.passwordAgain.errors?.noMatch">{{'pageBuilder.passwordNoMatch' | translate}}</mat-error>
      <mat-error *ngIf="editForm.passwordAgain.errors?.required">{{'pageBuilder.requiredField' | translate}}</mat-error>
    </mat-form-field>
  </mat-card>

  <mat-card class="my-2" *ngIf="authService.isAuthenticated()">
    <h2>{{'pageBuilder.description' | translate}}</h2>
    <mat-form-field appearance="fill" class="width-all-available">
      <mat-label>{{'pageBuilder.describe' | translate}}</mat-label>
      <textarea matInput formControlName="description" #description rows="10" (keyup)="limitDescriptionSize()"></textarea>
      <mat-hint align="end">{{description.value?.length || 0}}/1000</mat-hint>
      <mat-error *ngIf="editForm.description.errors?.max">{{'pageBuilder.textTooLong' | translate}}</mat-error>
    </mat-form-field>
  </mat-card>

  <mat-card class="my-2" *ngIf="authService.isAuthenticated()">
    <div class="social-media-links">
      <h2>{{'pageBuilder.socialMediaLinks' | translate}}</h2>
      <mat-form-field appearance="fill" class="width-all-available">
        <mat-label>Facebook</mat-label>
        <span matPrefix class="me-2"><fa-icon [icon]="faFacebook"></fa-icon></span>
        <input matInput type="text" formControlName="facebook" autocomplete="off" maxlength="300">
      </mat-form-field>
      <mat-form-field appearance="fill" class="width-all-available">
        <mat-label>Twitter</mat-label>
        <span matPrefix class="me-2"><fa-icon [icon]="faTwitter"></fa-icon></span>
        <input matInput type="text" formControlName="twitter" autocomplete="off" maxlength="300">
      </mat-form-field>
      <mat-form-field appearance="fill" class="width-all-available">
        <mat-label>LinkedIn</mat-label>
        <span matPrefix class="me-2"><fa-icon [icon]="faLinkedin"></fa-icon></span>
        <input matInput type="text" formControlName="linkedin" autocomplete="off" maxlength="300">
      </mat-form-field>
      <mat-form-field appearance="fill" class="width-all-available">
        <mat-label>GitHub</mat-label>
        <span matPrefix class="me-2"><fa-icon [icon]="faGithub"></fa-icon></span>
        <input matInput type="text" formControlName="github" autocomplete="off" maxlength="300">
      </mat-form-field>
    </div>
  </mat-card>

  <mat-card class="my-2" *ngIf="authService.isAuthenticated()">
    <div class="skills">
      <h2>{{isUserForm() ? ('pageBuilder.mySkills' | translate) : ('pageBuilder.ourServices' | translate)}}</h2>
      <mat-form-field appearance="fill" class="width-all-available" *ngIf="isUserForm()">
        <mat-label>{{'pageBuilder.languages' | translate}}</mat-label>
        <mat-chip-list #languagesChipList>
          <mat-chip *ngFor="let language of languages; let i = index" [selectable]="true" [removable]="true" (removed)="removeFromList(languages, i)">
            {{language}}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
          <input [placeholder]="'pageBuilder.writeAndPressEnter' | translate"
                 autocomplete="off"
                 [matChipInputFor]="languagesChipList"
                 [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                 [matChipInputAddOnBlur]="true"
                 (matChipInputTokenEnd)="addChipToList(languages, $event)">
        </mat-chip-list>
      </mat-form-field>

      <mat-form-field appearance="fill" class="width-all-available">
        <mat-label>{{isUserForm() ? ('pageBuilder.specialSkills' | translate) : ('pageBuilder.companySpecialSkills' | translate)}}</mat-label>
        <mat-chip-list #specialSkillsChipList>
          <mat-chip *ngFor="let specialSkill of specialSkills; let i = index" [selectable]="true" [removable]="true" (removed)="removeFromList(specialSkills, i)">
            {{specialSkill}}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
          <input [placeholder]="'pageBuilder.writeAndPressEnter' | translate"
                 autocomplete="off"
                 [matChipInputFor]="specialSkillsChipList"
                 [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                 [matChipInputAddOnBlur]="true"
                 (matChipInputTokenEnd)="addChipToList(specialSkills, $event)">
        </mat-chip-list>
      </mat-form-field>
    </div>
  </mat-card>

  <mat-card class="my-2" *ngIf="authService.isAuthenticated() && isUserForm()">
    <div class="work-histories">
      <h2>{{'pageBuilder.workHistory' | translate}}</h2>

      <div class="work-history" formArrayName="workHistories" *ngFor="let workHistory of workHistories.controls; let i = index" [ngClass]="{'mb-4': i < workHistories.controls.length - 1}">
        <mat-card class="mat-elevation-z0">
          <mat-card-actions>
            <button (click)="moveUp(workHistories, i)" class="mat-elevation-z2 mx-1" color="primary" mat-mini-fab [matTooltip]="'pageBuilder.moveUp' | translate" *ngIf="i - 1 >= 0">
              <mat-icon>arrow_upward</mat-icon>
            </button>
            <button (click)="moveDown(workHistories, i)" class="mat-elevation-z2 mx-1" color="primary" mat-mini-fab [matTooltip]="'pageBuilder.moveUp' | translate" *ngIf="i + 1 < educations.controls.length">
              <mat-icon>arrow_downward</mat-icon>
            </button>
            <button (click)="removeFromList(workHistories, i)" class="mat-elevation-z2" color="warn" mat-mini-fab [matTooltip]="'miscellaneous.delete' | translate">
              <mat-icon>delete</mat-icon>
            </button>
          </mat-card-actions>
          <div [formGroupName]="i">
            <div class="group-row">
              <mat-form-field appearance="fill" class="width-all-available">
                <mat-label>{{'pageBuilder.workPlace' | translate}}</mat-label>
                <input matInput type="text" autocomplete="organization" formControlName="workplace">
                <mat-error *ngIf="workHistory.get('workplace').errors?.required">{{'pageBuilder.requiredField' | translate}}</mat-error>
              </mat-form-field>
            </div>
            <mat-form-field appearance="fill" class="width-all-available">
              <mat-label>{{'pageBuilder.workTitle' | translate}}</mat-label>
              <input matInput type="text" autocomplete="organization-title" formControlName="title" maxlength="300">
              <mat-error *ngIf="workHistory.get('title').errors?.required">{{'pageBuilder.requiredField' | translate}}</mat-error>
            </mat-form-field>
            <mat-form-field appearance="fill" class="width-all-available">
              <mat-label>{{'pageBuilder.period' | translate}}</mat-label>
              <input matInput type="text" autocomplete="off" formControlName="period" maxlength="300">
              <mat-error *ngIf="workHistory.get('period').errors?.required">{{'pageBuilder.requiredField' | translate}}</mat-error>
            </mat-form-field>
            <mat-form-field appearance="fill" class="width-all-available">
              <mat-label>{{'pageBuilder.description' | translate}}</mat-label>
              <textarea matInput rows="5" formControlName="description" maxlength="1000"></textarea>
              <mat-error *ngIf="workHistory.get('description').errors?.required">{{'pageBuilder.requiredField' | translate}}</mat-error>
            </mat-form-field>
          </div>
        </mat-card>
      </div>
    </div>
    <div class="button-row my-3">
      <button mat-raised-button color="primary" class="add-button" (click)="addWorkHistoryFormGroup()">
        {{'pageBuilder.addWorkHistory' | translate}}
      </button>
    </div>
  </mat-card>

  <mat-card class="my-2" *ngIf="authService.isAuthenticated() && isUserForm()">
    <div class="educations">
      <h2>{{'pageBuilder.education' | translate}}</h2>

      <div class="education" formArrayName="educations" *ngFor="let education of educations.controls; let i = index" [ngClass]="{'mb-4': i < educations.controls.length - 1}">
        <mat-card class="mat-elevation-z0">
          <mat-card-actions>
            <button (click)="moveUp(educations, i)" class="mat-elevation-z2 mx-1" color="primary" mat-mini-fab [matTooltip]="'pageBuilder.moveUp' | translate" *ngIf="i - 1 >= 0">
              <mat-icon>arrow_upward</mat-icon>
            </button>
            <button (click)="moveDown(educations, i)" class="mat-elevation-z2 mx-1" color="primary" mat-mini-fab [matTooltip]="'pageBuilder.moveDown' | translate" *ngIf="i + 1 < educations.controls.length">
              <mat-icon>arrow_downward</mat-icon>
            </button>
            <button (click)="removeFromList(educations, i)" class="mat-elevation-z2 mx-1" color="warn" mat-mini-fab [matTooltip]="'miscellaneous.delete' | translate">
              <mat-icon>delete</mat-icon>
            </button>
          </mat-card-actions>
          <div [formGroupName]="i">
            <div class="group-row">
              <mat-form-field appearance="fill" class="width-all-available">
                <mat-label>{{'pageBuilder.educationPlace' | translate}}</mat-label>
                <input matInput type="text" autocomplete="off" formControlName="educationPlace">
                <mat-error *ngIf="education.get('educationPlace').errors?.required">{{'pageBuilder.requiredField' | translate}}</mat-error>
              </mat-form-field>
            </div>
            <mat-form-field appearance="fill" class="width-all-available">
              <mat-label>{{'pageBuilder.degree' | translate}}</mat-label>
              <input matInput type="text" autocomplete="off" formControlName="title" maxlength="300">
              <mat-error *ngIf="education.get('title').errors?.required">{{'pageBuilder.requiredField' | translate}}</mat-error>
            </mat-form-field>
            <mat-form-field appearance="fill" class="width-all-available">
              <mat-label>{{'pageBuilder.period' | translate}}</mat-label>
              <input matInput type="text" autocomplete="off" formControlName="period" maxlength="300">
              <mat-error *ngIf="education.get('period').errors?.required">{{'pageBuilder.requiredField' | translate}}</mat-error>
            </mat-form-field>
            <mat-form-field appearance="fill" class="width-all-available">
              <mat-label>{{'pageBuilder.description' | translate}}</mat-label>
              <textarea matInput rows="5" formControlName="description" maxlength="1000"></textarea>
              <mat-error *ngIf="education.get('description').errors?.required">{{'pageBuilder.requiredField' | translate}}</mat-error>
            </mat-form-field>
          </div>
        </mat-card>
      </div>
    </div>
    <div class="button-row my-3">
      <button mat-raised-button color="primary" class="add-button" (click)="addEducationFormGroup()">
        {{'pageBuilder.addEducation' | translate}}
      </button>
    </div>
  </mat-card>

  <mat-card class="my-2" *ngIf="isCompanyForm() && authService.isAuthenticated()">
    <h2>{{'pageBuilder.businessHours' | translate}}</h2>
    <ng-business-hours
        [(ngModel)]="businessHours"
        [ngModelOptions]="{standalone: true}"
        [timeFromLabel]="'pageBuilder.opens' | translate"
        [timeToLabel]="'pageBuilder.closes' | translate">
    </ng-business-hours>
  </mat-card>

  <mat-card *ngIf="authService.isAuthenticated()">
    <div class="theme-selector">
      <h2>{{'pageBuilder.pickTheme' | translate}}</h2>
      <input checked="checked" id="light" type="radio" name="theme" value="light" formControlName="theme"/>
      <label class="theme light" for="light">{{'pageBuilder.lightTheme' | translate}}</label>
      <input id="dark" type="radio" name="theme" value="dark" formControlName="theme"/>
      <label class="theme dark" for="dark">{{'pageBuilder.darkTheme' | translate}}</label>
    </div>
  </mat-card>

  <mat-card class="my-2" *ngIf="authService.isAuthenticated()">
    <h2>{{'pageBuilder.settings' | translate}}</h2>
    <mat-form-field appearance="fill" class="width-all-available">
      <mat-label>{{'pageBuilder.showMyProfileOnSearchPage' | translate}}</mat-label>
      <mat-select formControlName="public">
        <mat-option [value]="true">{{'miscellaneous.yes' | translate}}</mat-option>
        <mat-option [value]="false">{{'miscellaneous.no' | translate}}</mat-option>
      </mat-select>
    </mat-form-field>
    <mat-form-field appearance="fill" class="width-all-available">
      <mat-label>{{'pageBuilder.allowFacebookLogin' | translate}}</mat-label>
      <mat-select formControlName="allowFacebookLogin">
        <mat-option [value]="true">{{'miscellaneous.yes' | translate}}</mat-option>
        <mat-option [value]="false">{{'miscellaneous.no' | translate}}</mat-option>
      </mat-select>
    </mat-form-field>
    <mat-form-field appearance="fill" class="width-all-available">
      <mat-label>{{'pageBuilder.allowGoogleLogin' | translate}}</mat-label>
      <mat-select formControlName="allowGoogleLogin">
        <mat-option [value]="true">{{'miscellaneous.yes' | translate}}</mat-option>
        <mat-option [value]="false">{{'miscellaneous.no' | translate}}</mat-option>
      </mat-select>
    </mat-form-field>
  </mat-card>

  <div class="button-row mt-2">
    <button mat-raised-button color="warn" (click)="deleteProfile()" *ngIf="authService.isAuthenticated()" class="me-2">{{'pageBuilder.deleteMyProfile' | translate}}</button>
    <button mat-raised-button color="primary" (click)="save()">{{authService.isAuthenticated() ? ('pageBuilder.save' | translate) : ('pageBuilder.register' | translate)}}</button>
  </div>
</form>
